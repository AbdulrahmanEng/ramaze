<html>
  <head>
    <title>#{@title}</title>
    <?r if @coderay ?>
      <style>
        #{CodeRay::Encoders[:html]::CSS.new.stylesheet}
      </style>
    <?r end ?>
    <link rel="stylesheet" href="/css/ramaze_error.css" />
    <script type="text/javascript" src="/js/jquery.js"></script>
  </head>
  <body>
    <img id="logo" alt="Ramaze" src="/ramaze.png" />

    <h1>#{@title}</h1>

    <table class="main">
      <tr class="head">
        <td>File</td><td>Line</td><td>Method</td>
      </tr>
      <?r @backtrace.each do |lines, hash, file, lineno, meth| ?>
        <tr id="line_#{hash}" style="background:rgb(#{@colors.shift},200,200);">
          <td>#{file}</td><td>#{lineno}</td><td><pre>#{meth}</pre></td>
        </tr>
        <tr id="source_#{hash}" style="display:none;">
          <td colspan="3">
            <div class="source">
              <table style="width:100%;">
                <tr>
                  <td colspan="2">vim #{file} +#{lineno}</td>
                </tr>
                <?r
                  if @coderay
                    code = lines.map{|no, code, cur| code}.join("\n")
                    options = {
                      :wrap => :div,
                      :line_numbers => :inline,
                      :line_number_start => (lineno.to_i - Global.inform_backtrace_size)
                      }
                     ?>
                     #{CodeRay.scan(code, :ruby).html(options)}
                <?r else ?>
                  <?r lines.each do |llineno, lcode, lcurrent| ?>
                    <tr class="source" #{'style="background:#faa;"' if lcurrent}>
                      <td>#{llineno}</td>
                      <td><pre>#{lcode.rstrip}</pre></td>
                    </tr>
                  <?r end ?>
                <?r end ?>
              </table>
            </div>
            <script type="text/javascript">
              $("tr#line_#{hash}").click(function(){$("tr#source_#{hash}").toggle()});
            </script>
          </td>
        </tr>
      <?r end ?>
    </table>
    <?r
      {
        'Session'   => Thread.current[:session],
        'Request'   => Thread.current[:request],
        'Response'  => Thread.current[:response],
        'Global'    => Global,
      }.each do |title, content|
        hash = [title, content].object_id.abs
      ?>
      <div class="additional">
        <h3 id="show_#{hash}">#{title}</h3>
        <pre style="display:none" id="is_#{hash}">#{content.pretty_inspect}</pre>
        <script type="text/javascript">
          $("h3#show_#{hash}").click(function(){$("pre#is_#{hash}").toggle()});
        </script>
      </div>
    <?r end ?>
  </body>
</html>
